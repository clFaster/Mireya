# Development Plan: Mireya (27-rework-client-api-authentication-flow branch)

*Generated on 2025-11-09 by Vibe Feature MCP*
*Workflow: [epcc](https://mrsimpson.github.io/responsible-vibe-mcp/workflows/epcc)*

## Goal
Rework the client-to-API authentication flow to implement a more secure and streamlined approach where the client generates its own credentials and manages authentication independently.

**Phase 1 (COMPLETED):** Backend implementation
- ✅ Extended User model for Screen users
- ✅ Updated registration endpoint to accept client-generated credentials
- ✅ Created Bonjour endpoint for authenticated screens
- ✅ Linked Display model to User via UserId
- ✅ Decoupled admin approval from credential generation
- ✅ Implemented JWT-based authentication for screens

**Phase 2 (CURRENT):** Client-side implementation
- Create shared Mireya.ApiClient library with NSwag-generated client
- Implement authentication service with JWT token management
- Create platform-agnostic credential storage interfaces
- Update Avalonia client to use new authentication flow
- Add SignalR client wrapper for real-time communication

## Explore

### Phase Entrance Criteria:
- [x] Development workflow started
- [x] GitHub issue details reviewed
### Tasks
- [x] Review GitHub issue #27 details
- [x] Examine Display model structure
- [x] Examine User model (extends IdentityUser)
- [x] Review ScreenManagementController endpoints
- [x] Review ScreenManagementService implementation
- [x] Review current registration flow (RegisterScreenRequest/Response)
- [x] Review current approval flow (ApproveScreenResponse)
- [x] Review Program.cs for Identity/JWT configuration
- [x] Review MireyaDbContext structure
- [x] Review Roles constants
- [x] Review ApprovalStatus enum

### Completed
- [x] Created development plan file
- [x] Explored current authentication implementation

### Findings

**Current Implementation:**
1. **User Model**: Extends `IdentityUser` with `CreatedAt` and `LastLoginAt` fields
2. **Display Model**: Has `UserId` (string, nullable) that links to User, includes `ScreenIdentifier` (10 chars, unique, generated by backend)
3. **Registration Flow**: 
   - Anonymous POST to `/api/ScreenManagement/register`
   - Backend generates ScreenIdentifier (NanoId, 10 chars, hex alphabet)
   - No credentials accepted from client
   - Returns ScreenIdentifier and ScreenName
   - Status set to Pending
4. **Approval Flow**:
   - Admin calls POST `/api/ScreenManagement/{id}/approve`
   - Creates User account with email `{ScreenIdentifier}@mireya.local`
   - Generates random password (backend, NanoId-based)
   - Adds user to "Screen" role
   - Links Display.UserId to created user
   - Returns password to admin (manual distribution required)
5. **Identity Configuration**:
   - Uses `AddIdentityApiEndpoints<User>()` (supports Bearer + Cookies)
   - Default endpoints: `/login`, `/register`, `/refresh`, etc.
   - Password requirements: 9+ chars, requires digit
   - Email required and unique
6. **No Bonjour Endpoint**: Currently doesn't exist

**Key Problems to Address:**
- Client doesn't generate credentials
- Backend generates password during approval
- No login flow for screens after registration
- No endpoint for screens to fetch their data after authentication
- Tight coupling between approval and credential creation

## Plan

### Phase Entrance Criteria:
- [x] Current codebase structure understood (Display model, User model, ScreenManagement service/controller)
- [x] Existing authentication implementation reviewed
- [x] Database context and migrations examined
- [x] Identity configuration and JWT setup understood
- [x] Requirements clarified and documented
- [x] Technical approach validated

### Tasks
- [x] Define database schema changes
- [x] Design new registration flow
- [x] Design authentication flow
- [x] Design Bonjour endpoint specification
- [x] Plan approval flow changes
- [x] Identify migration strategy
- [x] Document implementation approach

### Completed
- [x] Created detailed implementation plan

### Implementation Plan

#### 1. Database Model Changes

**Option A: Extend User Model (RECOMMENDED)**
- Keep existing `User` model extending `IdentityUser`
- Display.UserId already exists (string, nullable) - compatible with IdentityUser.Id
- Use roles to distinguish Screen users from Admin users
- **Pros**: Simpler, uses existing Identity infrastructure, no additional tables
- **Cons**: Screen users share table with admin users

**Option B: Create Separate ScreenUser Model**
- Create new `ScreenUser : IdentityUser` model
- Requires separate DbContext or discriminator
- **Pros**: Clear separation
- **Cons**: More complex, requires additional Identity configuration

**DECISION: Use Option A** - Extend existing User model, distinguish via roles

**No Display Model Changes Needed:**
- Display.UserId already exists (string, nullable)
- Already has ScreenIdentifier field
- Just need to populate UserId during registration instead of approval

#### 2. Registration Flow Changes

**New RegisterScreenRequest:**
```csharp
public class RegisterScreenRequest
{
    [Required]
    public string Username { get; set; }  // Client-generated (GUID or device ID)
    
    [Required]
    public string Password { get; set; }  // Client-generated secure password
    
    public string? DeviceName { get; set; }
    public int? ResolutionWidth { get; set; }
    public int? ResolutionHeight { get; set; }
}
```

**New RegisterScreenResponse:**
```csharp
public class RegisterScreenResponse
{
    public string ScreenIdentifier { get; set; }  // Backend-generated for display
    public string UserId { get; set; }             // User ID for reference
    public string ScreenName { get; set; }
}
```

**Registration Logic:**
1. Client sends username + password + device info
2. Backend creates User account immediately with UserManager
3. Add user to "Screen" role
4. Backend generates ScreenIdentifier (keep existing NanoId logic)
5. Create Display record with UserId linked
6. Set ApprovalStatus to Pending
7. Return ScreenIdentifier and UserId

#### 3. Authentication Flow

**Use Existing Identity API Endpoints:**
- POST `/login?useCookies=false` for JWT-based auth
- Request body: `{ "email": "username", "password": "password" }`
- Response: `{ "accessToken": "...", "refreshToken": "...", "expiresIn": 3600 }`
- Client stores tokens securely

**Note:** The email field is used for username in Identity's default login

#### 4. Bonjour Endpoint

**New Endpoint:**
```
GET /api/ScreenManagement/bonjour
Authorization: Bearer {token}
```

**Implementation:**
- Extract user ID from authenticated claims
- Find Display by UserId
- Return screen details

**Response:**
```csharp
public class BonjourResponse
{
    public string ScreenIdentifier { get; set; }
    public string ScreenName { get; set; }
    public string? Description { get; set; }
    public string ApprovalStatus { get; set; }
    public string? Location { get; set; }
    public int? ResolutionWidth { get; set; }
    public int? ResolutionHeight { get; set; }
    public DateTime? LastSeenAt { get; set; }
    public bool IsActive { get; set; }
}
```

#### 5. Approval Flow Changes

**Simplified ApproveScreenAsync:**
- Remove user creation logic
- Only update ApprovalStatus to Approved
- No password generation needed
- Return updated screen details

**New ApproveScreenResponse:**
```csharp
public class ApproveScreenResponse
{
    public ScreenDetailsResponse Screen { get; set; }
    // Password field removed!
}
```

#### 6. Migration Strategy

**Database Migration:**
- No schema changes needed (Display.UserId already exists)
- However, existing Displays may have null UserId if registered before this change
- Migration should handle existing pending screens gracefully

**Backward Compatibility:**
- Existing approved screens with UserId will continue working
- Existing pending screens (UserId = null) cannot authenticate until re-registered
- Consider adding admin notification for screens needing re-registration

#### 7. Security Considerations

**Password Requirements:**
- Client must generate strong passwords (recommend 32+ char random string)
- Backend validates using existing Identity password policy
- Store hashed passwords only (Identity handles this)

**Username Format:**
- Accept any string (let client decide: GUID, device ID, etc.)
- Use as email field in Identity: `username@mireya.local` or just `username`
- Ensure uniqueness (Identity handles this)

**Token Security:**
- JWT tokens expire (default Identity configuration)
- Use refresh tokens for long-lived sessions
- HTTPS required in production

## Code

### Phase Entrance Criteria:
- [x] Detailed implementation plan created
- [x] Database model changes defined
- [x] API endpoint specifications documented
- [x] Authentication flow design completed
- [x] Migration strategy planned
- [x] Testing approach defined

### Tasks
- [x] Update RegisterScreenRequest to accept Username and Password
- [x] Update RegisterScreenResponse to include UserId
- [x] Modify RegisterScreenAsync to create User account immediately
- [x] Add Screen user to "Screen" role during registration
- [x] Link Display.UserId to created user during registration
- [x] Create BonjourResponse DTO
- [x] Implement GET /api/ScreenManagement/bonjour endpoint
- [x] Update ApproveScreenAsync to remove user creation logic
- [x] Update ApproveScreenResponse to remove Password field
- [x] Build and verify no compilation errors
- [x] Test registration flow with client credentials
- [x] Test login flow using Identity API endpoints
- [x] Test Bonjour endpoint with authenticated user
- [x] Test approval flow (verify it only changes status)

### Completed
- [x] Updated RegisterScreenRequest to accept Username and Password fields
- [x] Updated RegisterScreenResponse to include UserId field
- [x] Modified RegisterScreenAsync to create User account during registration
- [x] User is added to "Screen" role during registration
- [x] Display.UserId is linked to created user during registration
- [x] Created BonjourResponse DTO with all required fields
- [x] Implemented GET /api/ScreenManagement/bonjour endpoint (requires Screen role)
- [x] Simplified ApproveScreenAsync to only update approval status
- [x] Removed Password field from ApproveScreenResponse
- [x] Project builds successfully
- [x] Tested complete authentication flow (register → login → bonjour) successfully
- [x] All backend changes for screen authentication complete

### Test Results
**Registration Test:**
- ✅ Screen registered with client-provided username/password
- ✅ User account created immediately (not during approval)
- ✅ UserId linked to Display record
- ✅ Screen added to "Screen" role
- ✅ Returns screenIdentifier, userId, and screenName

**Login Test:**
- ✅ Login with username/password via `/login?useCookies=false`
- ✅ Returns Bearer access token
- ✅ Token expires in 3600 seconds (1 hour)
- ✅ Refresh token provided

**Bonjour Test:**
- ✅ Authenticated screen can call `/api/ScreenManagement/bonjour`
- ✅ Returns complete screen details (identifier, name, status, etc.)
- ✅ Updates LastSeenAt timestamp
- ✅ Returns current approval status (Pending until admin approves)

**Approval Test:**
- ✅ ApproveScreenAsync now only updates approval status
- ✅ No user creation during approval
- ✅ No password in response
- ✅ Simplified logic working correctly

## Commit

### Phase Entrance Criteria:
- [x] All backend code changes implemented
- [x] Database migrations created and tested (none needed - Display.UserId already exists)
- [x] API endpoints functional and tested
- [x] Existing tests pass (no tests exist in project)
- [x] Code compiles without errors
- [x] Authentication flow works end-to-end

### Tasks
- [x] Review code for debug output/console logging
- [x] Review code for TODO/FIXME comments
- [x] Add test scripts to .gitignore
- [x] Final build verification
- [x] Ready to commit

### Completed
- [x] No debug output found in code
- [x] No TODO/FIXME comments remaining
- [x] Added test-*.ps1 pattern to .gitignore
- [x] Final build successful (1 pre-existing warning in unrelated file)
- [x] User performed additional cleanup (removed unnecessary props from responses)
- [x] All code quality checks passed

### Changes Summary

**Modified Files:**
1. `RegisterScreenRequest.cs` - Added Username and Password fields (required)
2. `RegisterScreenResponse.cs` - Added UserId field
3. `BonjourResponse.cs` - New DTO for screen data fetching
4. `ApproveScreenResponse.cs` - Removed Password field
5. `ScreenManagementService.cs` - Updated registration & approval logic, added GetBonjourAsync
6. `ScreenManagementController.cs` - Added Bonjour endpoint
7. `.gitignore` - Excluded test scripts

**Key Implementation Details:**
- User accounts created during registration (not approval)
- Screens assigned to "Screen" role automatically
- Display.UserId populated immediately on registration
- Approval flow simplified to only update status
- JWT-based authentication using existing Identity endpoints
- No database migration needed

## Key Decisions

### 1. User Model Strategy
**Decision:** Use existing User model (extends IdentityUser) for both Admin and Screen users
**Rationale:** 
- Display.UserId already exists and is compatible
- Simpler implementation using existing Identity infrastructure
- Roles distinguish user types
- No additional tables or complex configuration needed

### 2. Username Format
**Decision:** Accept client-provided username as-is, use it as the email field
**Rationale:**
- Identity requires email field, so we'll use username@mireya.local format or accept email-like format
- Client decides format (GUID, device ID, etc.)
- Backend validates uniqueness via Identity

### 3. Authentication Method
**Decision:** Use JWT tokens (useCookies=false on login endpoint)
**Rationale:**
- Better for desktop/mobile clients
- Stateless authentication
- Client can store tokens securely
- Supports refresh tokens for long-lived sessions

### 4. Registration Timing
**Decision:** Create User account immediately during registration (before approval)
**Rationale:**
- Decouples authentication from approval
- Screen can authenticate immediately after registration
- Bonjour endpoint can check ApprovalStatus to determine if screen is approved
- Simplifies approval flow (only status change, no user creation)

## Notes

### Important Implementation Details
- No database migration needed (Display.UserId already exists)
- Existing pending screens with null UserId will need re-registration
- Identity API endpoints already exist: `/login`, `/refresh`, etc.
- Password validation uses existing Identity configuration (9+ chars, requires digit)

---
*This plan is maintained by the LLM. Tool responses provide guidance on which section to focus on and what tasks to work on.*
